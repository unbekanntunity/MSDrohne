from drohnev2.wifi import *
from drohnev2.configuration import *

import os

def startup():
    config = Configuration('./drohnev2/wlan_config/data/network.json', load_at_init=True)
    networks = config.config_dict['networks']
    nic = activate_nic()
    scanned_networks = scan(nic)
    #print(networks)
    #print(scanned_networks)

    names = [network[0] for network in scanned_networks]

    connected = False

    for network in networks:
        if network['name'] in names:
            index = names.index(network['name'])
            result = connect(nic, network['name'], network['password'])
            if result:
                print(f'connected to {network["name"]}')
                connected = True
                break

    if connected:
        server = Wlan_Server(nic)
        result = server.create_server()
        if result:
            server.server_loop()
    else:
       print('Couldnt connect to any network')

if __name__ == '__main__':
    startup()

