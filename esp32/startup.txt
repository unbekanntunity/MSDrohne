from drohnev2.wifi import *
from drohnev2.configuration import *
import os


def startup():
    nic = activate_nic()
    config = Configuration('./drohnev2/wlan_config/data/network.json', load_at_init=True)
    scanned_networks = scan(nic)
    networks = config.config_dict['networks']

    names = [network[0] for network in scanned_networks]

    connected = False
    for network in networks:
        if network['name'] in names:
            index = names.index(network['name'])
            result = connect(nic, network['name'], network['password'])
            if result:
                print(f'connected to {network["name"]}')
                connected = True
                break

    if connected:
        server = Wlan_Server(nic)
        result = server.create_server()
        if result:
            server.server_loop()
    else:
       print('Could not connect to any network')


if __name__ == '__main__':
    startup()


